<div class="container-fluid">
  <div class="container-fluid">
    <div class="card ml-4 mt-2 mb-3" style="background-color: #fbfbfb">
        <div class="card-body">
            <div class="d-flex megabar-header menu">
              <div class="toggle-b-space"></div>
              <div class="menu-middle">
                <H2>{{ modelName }}</H2>
              </div>
              <div class="d-flex justify-content-end">
                <p-calendar
                [(ngModel)]="rangeDates"
                (ngModelChange)="dateFilterChange()"
                selectionMode="range"
                dateFormat="dd/mm"
                [readonlyInput]="true"
                inputId="range"
                placeholder="Filtrer par date/période"
                [showClear]="false"
                (onClearClick)="setCalendar()"
                [showButtonBar]="false"
                [showIcon]="true"
                class="ml-0"
                [style]="{ width: '250px' }"
                [touchUI]="true"
                [showOnFocus]="true"
                [iconDisplay]="'input'"
              >
                <ng-template pTemplate="footer">
                  <div style="display: flex; align-items: center">
                    <p-button
                      label="All"
                      styleClass="p-button-text"
                      (click)="allDateFilter()"
                    ></p-button>
                    <p-button
                      label="Aujourd'hui"
                      styleClass="p-button-text"
                      (click)="todayDate()"
                    ></p-button>
                    <p-button
                      label="Hier"
                      styleClass="p-button-text"
                      (click)="yesterdayDate()"
                    ></p-button>
                    <p-button
                      label="Semaine"
                      styleClass="p-button-text"
                      (click)="weekDate()"
                    ></p-button>
                    <p-button
                      label="15 jours"
                      styleClass="p-button-text"
                      (click)="twoWeekDate()"
                    ></p-button>
                    <p-button
                      label="Mois"
                      styleClass="p-button-text"
                      (click)="monthDate()"
                    ></p-button>
                    <p-button styleClass="p-button-text" (click)="previousDate()">
                      <i class="pi pi-arrow-left"></i>
                    </p-button>
                    <p-button styleClass="p-button-text" (click)="nextDate()">
                      <i class="pi pi-arrow-right"></i>
                    </p-button>
                    <p-button
                      label="Clear"
                      styleClass="p-button-text"
                      (click)="clearDate()"
                    ></p-button>
                  </div>
                </ng-template>
              </p-calendar>
              </div>
          </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">
      <!-- Left Column: Model List -->
      <div class="col-md-3 mb-3">
        <div class="card shadow-sm rounded" style="background-color: #f8f9fa">

          <div class="card-body p-3">
            <!-- Filter Input -->
            <div class="flex flex-column gap-2">
              <input
                pInputText
                id="username"
                aria-describedby="username-help"
                [(ngModel)]="filterQuery"
                (input)="filterModels()"
              />
              <small id="username-help">Filter models</small>
            </div>

            <!-- Model List -->
            <div
              class="list-container"
              style="overflow-y: auto; max-height: 50rem"
            >
              <ul class="list-unstyled mb-0">
                <li
                  *ngFor="let model of filteredModels"
                  [class.selected]="model === selectedModel"
                  class="model-item p-2 mb-2 rounded shadow-sm"
                  style="
                    cursor: pointer;
                    border: 1px solid #ddd;
                    background-color: #ffffff;
                    color: rgb(31, 31, 31);
                  "
                  (click)="selectModel(model)"
                >
                  <div class="d-flex align-items-center">
                    <div class="flex-1">
                      <h6>{{ model.name }}</h6>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Product Table & History -->
      <div class="col-md-9 d-flex flex-column">
        <!-- Centered Table -->
        <div
          class="card shadow-sm rounded mb-3 align-items-center"
          style="background-color: #f8f9fa; width: 100%"
        >
        <div class="card-header d-flex align-items-center flex-wrap">
          <div class="d-flex flex-wrap align-items-center w-100">
          <div class="menu-middle">
            <p-checkbox
              class="ml-4 mt-2"
              [binary]="true"
              inputId="binary"
              [(ngModel)]="hide0"
            ></p-checkbox>
            <label class="ml-2 mt-3" for="ny">Masquer 0</label>
            <p-checkbox
              class="ml-4 mt-2"
              [binary]="true"
              inputId="binary"
              [(ngModel)]="delaiEnabled"
            ></p-checkbox>
            <label class="ml-2 mt-3" for="ny">Afficher délai</label>
            <p-checkbox
              class="ml-4 mt-2"
              [binary]="true"
              inputId="binary"
              [(ngModel)]="stock"
            ></p-checkbox>
            <label class="ml-2 mt-3" for="ny">stock</label>
          </div>
            <div class="d-flex justify-content-end">
              <p-toggleButton
              [(ngModel)]="selectAll"
              [onLabel]="'Déselectionner tout'"
              offLabel="Sélectionner tout"
              (click)="selectAllProducts()"
              class="pl-2"
            ></p-toggleButton>
            </div>

          </div>


            <div class="d-flex align-items-center flex-wrap w-100 mt-2">
              <div class="menu-middle">
              <input
                pInputText
                [(ngModel)]="comment"
                placeholder="Votre commentaire"
                class="pr-4 pl-5"
              />

              <p-inputNumber
                [(ngModel)]="qte"
                mode="decimal"
                inputId="withoutgrouping"
                [useGrouping]="false"
                (keyup.enter)="add()"
                class="pr-4 pl-5"
              >
              </p-inputNumber>
            </div>
            <div class="d-flex justify-content-end">
              <p-button
                label="Ajouter"
                icon="pi pi-check"
                iconPos="right"
                (click)="add()"
              ></p-button>
            </div>
            </div>


        </div>
          <div class="card-body p-3">
            <p-table
              [value]="productsCount"
              styleClass="p-datatable-gridlines"
              #dt
            >
              <ng-template pTemplate="body" let-productSizes let-j="rowIndex">
                <tr>
                  <td
                    class="text-center td-width"
                    (click)="handleColorClick(j)"
                    style="cursor: pointer; background-color: #e9ecef"
                  >
                    <h6 class="mb-0">
                      {{ productSizes[0].color.name }}: {{ totalRow(j) }}
                    </h6>
                  </td>
                  <ng-container
                    *ngFor="
                      let productSize of productSizes;
                      let colIndex = index
                    "
                  >
                    <ng-container *ngIf="!hide0 && colIndex < sizes.length">
                      <td
                        pEditableColumn
                        (click)="onCellClick(productSize)"
                        class="text-center td-width p-2"
                        style="cursor: pointer"
                        [ngStyle]="{
                          'background-color': isProductSelected(productSize.id)
                            ? 'rgb(220, 231, 243)'
                            : isProductEdited(productSize.id)
                            ? 'rgb(152, 251, 152)'
                            : ''
                        }"
                      >
                        <ng-container>
                          <div *ngIf="productSize.countOos > 0">
                            <p-badge [value]="productSize.countOos" severity="danger" />
                          </div>
                          <h6>
                            {{ productSize.color.name }}
                            {{ productSize.size.reference }}
                          </h6>
                          <div *ngIf="!stock">
                            <p-badge *ngIf="productSize.countProgress> 0" [value]="productSize.countProgress" severity="info" />
                            <h4>{{ productSize.countPayed }}</h4>
                            <small *ngIf="productSize.countExchange !== 0"
                              >Exchange: {{ productSize.countExchange }}</small
                            >
                          </div>
                          <div *ngIf="stock">
                            <h6>{{ productSize.qte }}</h6>
                            <ng-container
                              *ngIf="getDaysStock(productSize) as delai"
                            >
                              <div class="text-center mt-2">
                                <p-tag
                                  [value]="
                                    getSeverityMsg(productSize.qte, delai)
                                  "
                                  [severity]="
                                    getSeverity(productSize.qte, delai)
                                  "
                                ></p-tag>
                              </div>
                              <div *ngIf="delaiEnabled">
                                <h4>{{ delai }} days</h4>
                              </div>
                            </ng-container>
                          </div>
                        </ng-container>
                      </td>
                    </ng-container>
                  </ng-container>
                </tr>
              </ng-template>
              <ng-template pTemplate="footer">
                <tr>
                  <td class="td-width">
                    <strong>Total Size {{ totalTable() }}</strong>
                  </td>
                  <ng-container *ngFor="let size of sizes; let index = index">
                    <ng-container *ngIf="!(hide0 && totalColumn(index) < 1)">
                      <td (click)="handleSizeClick(index)" class="td-width">
                        {{ totalColumn(index) }}
                      </td>
                    </ng-container>
                  </ng-container>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>

        <!-- History below the table -->
        <div
          class="card shadow-sm rounded mb-3"
          style="background-color: #f8f9fa; width: 80%"
          >
          <div class="card-header d-flex align-items-center flex-wrap">
            <div class="d-flex flex-wrap align-items-center w-100">
              <button
                pButton
                pRipple
                icon="pi pi-search"
                class="p-button-success p-button-sm"
                (click)="getProductHistory()"
              ></button>
              <input
                pInputText
                type="text"
                [(ngModel)]="searchField"
                placeholder="Référence produit"
                class="mr-3 ml-2"
                (keyup.enter)="getProductHistory()"
              />
            </div>
          </div>
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center">
              <h3>History</h3>
              <p-selectButton
                [options]="enablerHistoryOptions"
                [(ngModel)]="historyEnabler"
                optionLabel="label"
                optionValue="value"
                (click)="historyEnablerChange()"
              ></p-selectButton>
            </div>
            <app-stock-history
              *ngIf="historyEnabler"
              [productsHistory]="productsHistory"
              [modelId]="modelId"
              (deleteProductsHistoryEvent)="onDeleteProductsHistory($event)"
            ></app-stock-history>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="card ml-4 mt-2 mb-3 p-3" style="background-color: #fbfbfb">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <H3>Chart</H3>
        </div>
        <div>
          <p-selectButton
            [options]="chartOptions"
            [(ngModel)]="selectedChart"
            (onOptionClick)="chartEnablerChange()"
          ></p-selectButton>
        </div>
        <div>
          <p-selectButton
            [options]="chartEnablerOptions"
            [(ngModel)]="chartEnabler"
            optionLabel="label"
            optionValue="value"
            (click)="chartEnablerChange()"
          ></p-selectButton>
        </div>
      </div>
      <p-card *ngIf="chartEnabler">
        <p-chart
          type="line"
          [data]="basicData"
          [options]="basicOptions"
        ></p-chart>
      </p-card>
    </div>
  </div>
</div>
<p-toast position="bottom-right"></p-toast>
